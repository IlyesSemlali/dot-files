#!/bin/bash

# Lock mechanism
kill $(cat .cache/monitor.lock) > /dev/null 2>&1
echo $$ > .cache/monitor.lock

# get xrandr informations
PRIMARY=$(xrandr| grep ' primary' | awk '{ print $1 }')
SECONDARY=$(xrandr| grep ' connected' | grep -v $PRIMARY | awk '{ print $1 }')
PRIMARY_RES=$(xrandr | grep "^$PRIMARY" -A 20 | grep \* | head -1 | awk '{print $1}')
SECONDARY_RES=$(xrandr | grep "^$SECONDARY" -A 20 | grep \* | head -1 | awk '{print $1}')
OFFSET=100

# Main menu
declare -a options=("expand
monitor only
duplicate
--disconnect--")

# Expansion menu
declare -a expand_options=("above
left
right")

choice=$(echo -e "${options[@]}" | rofi -l 6 -width 13 -dmenu -p 'Monitor' | awk '{print $NF}')

function check_secondary_monitor_connection() {
    if xrandr| grep -e $SECONDARY | grep -v $PRIMARY | grep -vq disconnected
    then
        return 0
    else
        return 1
    fi
}

function refresh() {
    xdotool key super+shift+r
    feh -F --bg-fill ~/.wallpaper
}

function monitor_output() {
    xrandr --output $PRIMARY --off
    xrandr --output $SECONDARY --auto
    rm ~/.lockscreen.png
    refresh
    fallback
}

function laptop_output() {
    xrandr --output $SECONDARY --off
    xrandr -s 0
    xrandr --output $PRIMARY --auto
    refresh
}

function duplicate_output() {
    xrandr --output $SECONDARY --mode $PRIMARY_RES --same-as $PRIMARY
    refresh
    fallback
}

function expand_output() {
    case $1 in
        right)
            SECONDARY_HEIGHT=$(echo $SECONDARY_RES | cut -d 'x' -f2)
            PRIMARY_WIDTH=$(echo $PRIMARY_RES | cut -d 'x' -f1)
            xrandr --output $PRIMARY --pos 0x$(( $SECONDARY_HEIGHT - $OFFSET )) --output $SECONDARY --pos $(( PRIMARY_WIDTH ))x0
            unset SECONDARY_HEIGHT PRIMARY_WIDTH
            ;;
        left)
            SECONDARY_HEIGHT=$(echo $SECONDARY_RES | cut -d 'x' -f2)
            SECONDARY_WIDTH=$(echo $SECONDARY_RES | cut -d 'x' -f1)
            xrandr --output $PRIMARY --pos ${SECONDARY_WIDTH}x$(( $SECONDARY_HEIGHT - $OFFSET )) --output $SECONDARY --pos 0x0
            unset SECONDARY_HEIGHT SECONDARY_WIDTH
            ;;
        above|below)
            xrandr --output $SECONDARY --auto --${1} $PRIMARY
            ;;
    esac

    refresh
    fallback
}

function fallback () {
    # Check if secondary monitor is still connected
    while check_secondary_monitor_connection
    do
        sleep 1
    done
    echo falling back

    xrandr --output $SECONDARY --off
    xrandr -s 0
    xrandr --output $PRIMARY --auto
    refresh
}

case $choice in
    expand)
        expansion=$(echo -e "${expand_options[@]}" | rofi -l 6 -width 13 -dmenu -p 'Monitor' | awk '{print $NF}')
        expand_output $expansion
        ;;
    duplicate)
        duplicate_output
        ;;
    only)
        monitor_output
        ;;
    --disconnect--)
        laptop_output
        ;;
    *)
        exit 1
        ;;
esac

