#!/bin/bash

## This relies on wttr.in

CONDITION=$(curl -s wttr.in/$LOCATION?format=%C | tr '[:upper:]' '[:lower:]')
DAY_TIER=afternoon

function set_manual () {
    v4l2-ctl --set-ctrl exposure_auto=1
    v4l2-ctl --set-ctrl exposure_auto_priority=0
    v4l2-ctl --set-ctrl focus_auto=0
    v4l2-ctl --set-ctrl focus_absolute=20
    v4l2-ctl --set-ctrl white_balance_temperature_auto=0
}

function set_auto () {
    v4l2-ctl --set-ctrl exposure_auto=3
    v4l2-ctl --set-ctrl exposure_auto_priority=1
    v4l2-ctl --set-ctrl focus_auto=0
    v4l2-ctl --set-ctrl focus_absolute=20
    v4l2-ctl --set-ctrl white_balance_temperature_auto=1
}


function home_morning_rainy () {
    false
}

function home_afternoon_rainy () {
    false
}

function home_morning_sunny () {
    false
}

function home_afternoon_sunny () {
    v4l2-ctl --set-ctrl backlight_compensation=0
    v4l2-ctl --set-ctrl brightness=128
    v4l2-ctl --set-ctrl contrast=115
    v4l2-ctl --set-ctrl exposure_absolute=270
    v4l2-ctl --set-ctrl saturation=128
    v4l2-ctl --set-ctrl white_balance_temperature=4000
}

function print () {
    v4l2-ctl --list-ctrls | awk '{
        for(i=1; i<=NF; i++) {
            tmp=match($i, /value=/)
            if(tmp) {
                print "v4l2-ctl --set-ctrl " $1 "=" $i
            }
        }
    }'  | sed 's/value=//' \
        | sort \
        | grep -v '\(pan\|tilt\|zoom\|sharp\|gain\|frequency\|auto\|focus\)'
        # | column -o ' = ' -t
}

function show () {
    kill $(cat ~/.cache/webcam.pid)
    echo $$ > ~/.cache/webcam.pid

    ffplay -vf hflip -fs $(v4l2-ctl --list-devices | grep -A2 Webcam | tail -2 | head -1 | sed 's/^\s*//')
}

case $1 in
    home)
        set_manual
        $1_${DAY_TIER}_${CONDITION} || set_auto
        ;;
    office)
        set_auto
        ;;
    print)
        print
        ;;
esac
