#!/usr/bin/env bash

GITREPOS="$HOME/git/"

WORKTREES="$(find "$GITREPOS" -maxdepth 3 -mindepth 2 -name '.git' -type d | \
  sed "s/\/\.git//g" | sed "s@$GITREPOS@@g" | \
  sort | fzf -m --border-label='Repositories')"

if [ -z $PROJECT ]; then
  echo "PROJECT is not set"
  exit 1
else
  if [ -z "$WORKTREES" ]; then
    exit 0 # It means we didn't select anything with fzf

  else
    for WORKTREE in $WORKTREES; do

      if [ -n $REPO_EXCLUDE_PATTERN ] && echo $WORKTREE | grep -q $REPO_EXCLUDE_PATTERN; then
        ln -sf $WORKTREE "$HOME/projects/$PROJECT/$(basename $(echo $WORKTREE))"
      else
        git -C $WORKTREE worktree add "$HOME/projects/$PROJECT/$(basename $(echo $WORKTREE))" -B $PROJECT
      fi

    done
  fi
fi
