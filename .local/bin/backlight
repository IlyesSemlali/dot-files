#!/bin/bash


LOCK=/tmp/backlight.lock
STATE=~/.cache/backlight.state

MIN=10
MAX=90

function set_absolute () {
    if ! [ -e ${LOCK} ]
    then
        id -u > ${LOCK}
        pkill -f '.*xbacklight.*'
        echo $1 > ${STATE}
        xbacklight -time 500 -fps 30 -set $1 &
        rm -f ${LOCK}
    fi
}

function soft_transition () {
    if ! [ -e ${LOCK} ]
    then
        id -u > ${LOCK}
        pkill -f '.*xbacklight.*'
        echo $1 > ${STATE}
        xbacklight -time 20000 -fps 30 -set $1 &
        rm -f ${LOCK}
    fi
}

function dim () {
    xbacklight -time 2000 -fps 30 -dec 10 -perceived &
}

function resume_from_state () {
    set_absolute $(cat ${STATE})
}

function increase () {
    pkill -f '.*xbacklight.*'
    xbacklight -inc 2 -fps 30 -perceived
    xbacklight -get > ${STATE}
}

function decrease () {
    pkill -f '.*xbacklight.*'
    xbacklight -dec 2 -fps 30 -perceived
    xbacklight -get > ${STATE}
}

function min () {
    pkill -f '.*xbacklight.*'
    echo $MIN > ${STATE}
    xbacklight -set $MIN -fps 30 &
}

function max () {
    pkill -f '.*xbacklight.*'
    echo $MAX > ${STATE}
    xbacklight -set $MAX -fps 30 &
}

case $1 in
    dim|increase|decrease|min|max)
        $1
        ;;
    resume)
        resume_from_state
        ;;
    set_absolute|soft_transition)
        $1 $2
        ;;
    *)
        exit 1
        ;;
esac
